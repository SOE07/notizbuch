<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mein Notizbuch</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='cover' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%232c3e50'/%3E%3Cstop offset='100%25' stop-color='%231a252f'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='10' y='4' width='44' height='56' rx='3' fill='url(%23cover)'/%3E%3Crect x='14' y='8' width='36' height='48' rx='2' fill='%23fffef8'/%3E%3Cline x1='22' y1='8' x2='22' y2='56' stroke='%23d8a0a0' stroke-width='1' opacity='0.6'/%3E%3Cline x1='18' y1='20' x2='46' y2='20' stroke='%23c0c8d4' stroke-width='0.8'/%3E%3Cline x1='18' y1='27' x2='46' y2='27' stroke='%23c0c8d4' stroke-width='0.8'/%3E%3Cline x1='18' y1='34' x2='46' y2='34' stroke='%23c0c8d4' stroke-width='0.8'/%3E%3Cline x1='18' y1='41' x2='46' y2='41' stroke='%23c0c8d4' stroke-width='0.8'/%3E%3Cline x1='18' y1='48' x2='46' y2='48' stroke='%23c0c8d4' stroke-width='0.8'/%3E%3Ccircle cx='10' cy='14' r='2.5' fill='%23888'/%3E%3Ccircle cx='10' cy='14' r='1.2' fill='%23f0ebe0'/%3E%3Ccircle cx='10' cy='26' r='2.5' fill='%23888'/%3E%3Ccircle cx='10' cy='26' r='1.2' fill='%23f0ebe0'/%3E%3Ccircle cx='10' cy='38' r='2.5' fill='%23888'/%3E%3Ccircle cx='10' cy='38' r='1.2' fill='%23f0ebe0'/%3E%3Ccircle cx='10' cy='50' r='2.5' fill='%23888'/%3E%3Ccircle cx='10' cy='50' r='1.2' fill='%23f0ebe0'/%3E%3Cpath d='M40 14 L44 14 L42 17Z' fill='%23e74c3c'/%3E%3Cline x1='25' y1='20' x2='38' y2='20' stroke='%232c3e50' stroke-width='1.2' opacity='0.5'/%3E%3Cline x1='25' y1='27' x2='42' y2='27' stroke='%232c3e50' stroke-width='1.2' opacity='0.4'/%3E%3Cline x1='25' y1='34' x2='36' y2='34' stroke='%232c3e50' stroke-width='1.2' opacity='0.3'/%3E%3C/svg%3E">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --paper: #ffffff;
    --paper-edge: #d0d0d0;
    --line-color: #c0c8d4;
    --margin-color: #d8a0a0;
    --ink: #2c3e50;
    --ink-light: #8899aa;
    --accent: #e74c3c;
    --tag-active: #3498db;
    --tag-bg: #e8f0fa;
    --shadow: rgba(0,0,0,0.12);
    --line-h: 36px;
  }

  body {
    font-family: Arial, sans-serif;
    background: #000000;
    color: var(--ink);
    height: 100vh;
    overflow: hidden;
    display: flex;
  }

  /* --- Sidebar --- */
  .sidebar {
    width: 250px;
    min-width: 250px;
    background: #f0ebe0;
    border-right: 1px solid #d8d0c0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  .sidebar-bottom {
    margin-top: auto;
    flex-shrink: 0;
  }

  .sidebar-header {
    padding: 18px 14px 12px;
    border-bottom: 1px solid #d8d0c0;
  }

  .sidebar-header h1 {
    font-family: Arial, sans-serif;
    font-size: 22px;
    margin-bottom: 8px;
  }

  .search-box { position: relative; }

  .search-box input {
    width: 100%;
    padding: 6px 10px 6px 28px;
    border: 1px solid #c8c0b0;
    border-radius: 6px;
    background: white;
    font-size: 12px;
    color: var(--ink);
    outline: none;
  }

  .search-box input:focus { border-color: var(--tag-active); }

  .search-box::before {
    content: '\1F50D';
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    opacity: 0.4;
  }

  .tags-section {
    padding: 10px 14px;
    border-bottom: 1px solid #d8d0c0;
  }

  .tags-section h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--ink-light);
    margin-bottom: 6px;
  }

  .tag-filters { display: flex; flex-wrap: wrap; gap: 4px; }

  .tag-chip {
    padding: 2px 7px;
    border-radius: 8px;
    background: var(--tag-bg);
    color: var(--ink);
    font-size: 11px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
    user-select: none;
  }

  .tag-chip:hover { background: #d0e0f0; }
  .tag-chip.active { background: var(--tag-active); color: white; }
  .tag-chip .tc { margin-left: 3px; font-size: 9px; opacity: 0.6; }

  .sidebar-actions {
    padding: 10px 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    border-bottom: 1px solid #d8d0c0;
  }

  .sb-btn {
    padding: 7px;
    border: 1px solid #c8c0b0;
    border-radius: 6px;
    background: white;
    color: var(--ink-light);
    font-size: 11px;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
  }

  .sb-btn:hover { background: var(--tag-bg); color: var(--ink); }
  .sb-btn.primary { background: var(--accent); color: white; border-color: var(--accent); }
  .sb-btn.primary:hover { background: #c0392b; }

  .sb-btn.file-linked { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
  .sb-btn.file-linked:hover { background: #c8e6c9; }

  .file-status {
    font-size: 9px;
    color: var(--ink-light);
    text-align: center;
    padding: 2px 14px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .file-status.active { color: #2e7d32; }

  .page-list { flex: 1; overflow-y: auto; padding: 2px 0; }

  .pg-item {
    padding: 8px 14px;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.1s;
  }

  .pg-item:hover { background: #e8e2d5; }
  .pg-item.active { background: var(--paper); border-left-color: var(--tag-active); }

  .pg-item-preview {
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
  }

  .pg-item-meta { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }
  .pg-item-date { font-size: 9px; color: var(--ink-light); }

  .pg-item-tag {
    font-size: 8px;
    padding: 1px 4px;
    border-radius: 4px;
    background: var(--tag-bg);
    color: var(--ink-light);
  }

  .pg-count {
    padding: 5px 14px;
    font-size: 9px;
    color: var(--ink-light);
    text-align: center;
    border-top: 1px solid #d8d0c0;
  }

  .version-info {
    padding: 8px 14px;
    font-size: 10px;
    color: var(--ink-light);
    text-align: center;
    opacity: 0.75;
    border-top: 1px solid #d8d0c0;
    flex-shrink: 0;
  }

  /* --- Notebook area --- */
  .notebook-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 16px 56px;
    overflow: hidden;
  }

  /* Page arrows */
  .page-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.6);
    color: var(--ink-light);
    font-size: 22px;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .page-arrow:hover { background: white; color: var(--ink); box-shadow: 0 2px 8px var(--shadow); }
  .page-arrow:disabled { opacity: 0.15; cursor: default; pointer-events: none; }
  .page-arrow-left { left: 8px; }
  .page-arrow-right { right: 8px; }

  /* The paper */
  .paper {
    width: 100%;
    max-width: 560px;
    background: var(--paper);
    border-radius: 3px;
    box-shadow:
      2px 4px 16px rgba(0,0,0,0.18),
      -1px 0 0 var(--paper-edge),
      1px 0 0 var(--paper-edge);
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    touch-action: pan-y;
  }

  /* Margin line */
  .paper::before {
    content: '';
    position: absolute;
    left: 120px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--margin-color);
    opacity: 0.35;
    z-index: 2;
    pointer-events: none;
  }

  /* Spiral holes decoration */
  .paper::after {
    content: '';
    position: absolute;
    left: -6px;
    top: 30px;
    bottom: 30px;
    width: 12px;
    background-image: radial-gradient(circle 5px at 6px center, #999 4px, transparent 4.5px);
    background-size: 12px 40px;
    background-repeat: repeat-y;
    z-index: 3;
    pointer-events: none;
    opacity: 0.3;
  }

  .paper-header {
    padding: 10px 16px 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 36px;
  }

  .paper-page-info {
    font-family: Arial, sans-serif;
    font-size: 15px;
    color: var(--ink-light);
  }

  .paper-del-btn {
    font-size: 10px;
    color: var(--ink-light);
    background: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 2px 8px;
    cursor: pointer;
    opacity: 0.4;
    transition: all 0.15s;
  }

  .paper-del-btn:hover { opacity: 1; color: var(--accent); border-color: var(--accent); }

  /* Lines area – checkered (Karo) pattern */
  .lines-area {
    flex: 1;
    padding: 0 12px 0 6px;
    position: relative;
    background-image:
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent calc(var(--line-h) - 1px),
        var(--line-color) calc(var(--line-h) - 1px),
        var(--line-color) var(--line-h)
      ),
      repeating-linear-gradient(
        90deg,
        transparent,
        transparent calc(var(--line-h) - 1px),
        var(--line-color) calc(var(--line-h) - 1px),
        var(--line-color) var(--line-h)
      );
  }

  .line-row {
    display: flex;
    align-items: flex-start;
    min-height: var(--line-h);
    gap: 2px;
  }

  /* ToDo toggle button (3 states: none → open → done → none) */
  .line-todo {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    cursor: pointer;
    border: none;
    background: transparent;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 3px;
    transition: all 0.15s;
    font-size: 15px;
    line-height: 1;
    color: #ccc5b5;
    margin-top: calc((var(--line-h) - 18px) / 2);
  }

  .line-todo:hover { color: var(--ink-light); }

  .line-todo.is-todo {
    color: var(--tag-active);
    opacity: 0.85;
  }

  .line-todo.is-done {
    color: var(--tag-active);
    opacity: 1;
  }

  .line-text.done {
    text-decoration: line-through;
    color: var(--ink-light);
    opacity: 0.5;
  }

  /* Priority button (only visible for todo lines) */
  .line-prio {
    width: 22px;
    height: 20px;
    flex-shrink: 0;
    cursor: pointer;
    border: 1px dashed #ccc;
    background: transparent;
    padding: 0;
    display: none;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    line-height: 1;
    margin-top: calc((var(--line-h) - 20px) / 2);
    transition: all 0.15s;
    font-family: Arial, sans-serif;
    color: var(--ink-light);
  }

  .line-prio.visible { display: flex; }
  .line-prio.prio-none { color: var(--ink-light); background: #f5f3ee; border-style: dashed; }
  .line-prio.prio-a { color: #fff; background: #e74c3c; border-color: #c0392b; border-style: solid; }
  .line-prio.prio-b { color: #fff; background: #e67e22; border-color: #d35400; border-style: solid; }
  .line-prio.prio-c { color: #fff; background: #27ae60; border-color: #1e8449; border-style: solid; }
  .line-prio:hover { opacity: 0.8; transform: scale(1.1); }

  /* Sidebar tabs */
  .sidebar-tabs {
    display: flex;
    border-bottom: 1px solid #d8d0c0;
  }

  .sidebar-tab {
    flex: 1;
    padding: 8px;
    font-size: 11px;
    font-weight: 500;
    text-align: center;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--ink-light);
    cursor: pointer;
    transition: all 0.15s;
  }

  .sidebar-tab:hover { color: var(--ink); background: #e8e2d5; }
  .sidebar-tab.active { color: var(--tag-active); border-bottom-color: var(--tag-active); }

  /* ToDo section */
  .todo-section { display: none; flex-direction: column; flex: 1; overflow: hidden; }
  .todo-section.visible { display: flex; }

  .todo-filters {
    display: flex;
    gap: 4px;
    padding: 8px 14px;
    border-bottom: 1px solid #d8d0c0;
    flex-wrap: wrap;
  }

  .todo-filter {
    padding: 3px 8px;
    border-radius: 8px;
    background: #f0ebe0;
    color: var(--ink-light);
    font-size: 10px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
    user-select: none;
  }

  .todo-filter:hover { background: #e0d8c8; }
  .todo-filter.active { background: var(--tag-active); color: white; }
  .todo-filter .tf-count { margin-left: 2px; opacity: 0.7; }

  .todo-tag-filters {
    display: flex;
    gap: 3px;
    padding: 6px 14px;
    border-bottom: 1px solid #d8d0c0;
    flex-wrap: wrap;
  }

  .todo-tag-chip {
    padding: 2px 6px;
    border-radius: 6px;
    background: var(--tag-bg);
    color: var(--ink);
    font-size: 9px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.12s;
  }

  .todo-tag-chip:hover { background: #d0e0f0; }
  .todo-tag-chip.active { background: var(--tag-active); color: white; }

  .todo-list {
    flex: 1;
    overflow-y: auto;
    padding: 2px 0;
  }

  .todo-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    cursor: pointer;
    transition: background 0.1s;
    border-bottom: 1px solid #f0ebe0;
  }

  .todo-item:hover { background: #e8e2d5; }

  .todo-item-check {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    cursor: pointer;
    border: none;
    background: transparent;
    font-size: 14px;
    color: var(--tag-active);
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .todo-item-check:hover { opacity: 0.7; }

  .todo-item-content {
    flex: 1;
    min-width: 0;
  }

  .todo-item-text {
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .todo-item-text.done {
    text-decoration: line-through;
    color: var(--ink-light);
    opacity: 0.5;
  }

  .todo-item-meta {
    font-size: 9px;
    color: var(--ink-light);
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .todo-item-tag {
    font-size: 8px;
    padding: 0 4px;
    border-radius: 3px;
    background: var(--tag-bg);
    color: var(--ink-light);
  }

  .todo-item-page {
    font-size: 8px;
    color: var(--tag-active);
    cursor: pointer;
  }

  .todo-item-page:hover { text-decoration: underline; }

  .todo-item-prio {
    font-size: 9px;
    font-weight: 700;
    padding: 0 4px;
    border-radius: 3px;
    line-height: 1.4;
  }

  .todo-item-prio.prio-a { color: #fff; background: #e74c3c; }
  .todo-item-prio.prio-b { color: #fff; background: #e67e22; }
  .todo-item-prio.prio-c { color: #fff; background: #27ae60; }

  .todo-count {
    padding: 5px 14px;
    font-size: 9px;
    color: var(--ink-light);
    text-align: center;
    border-top: 1px solid #d8d0c0;
  }

  /* Settings section */
  .settings-section {
    padding: 0;
    border-top: 2px solid #d8d0c0;
    flex-shrink: 0;
    background: #ede8dc;
  }

  .settings-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: var(--ink);
    padding: 10px 14px;
    user-select: none;
    transition: all 0.15s;
  }

  .settings-toggle:hover { color: var(--tag-active); background: #e8e2d5; }

  .settings-body {
    display: none;
    padding: 0 14px 10px;
  }

  .settings-body.open { display: block; }

  .settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 11px;
    color: var(--ink);
  }

  .settings-row input[type="time"] {
    width: 80px;
    padding: 3px 6px;
    border: 1px solid #c8c0b0;
    border-radius: 4px;
    font-size: 11px;
    background: white;
    color: var(--ink);
    outline: none;
  }

  .settings-row input[type="time"]:focus { border-color: var(--tag-active); }

  .switch {
    position: relative;
    width: 36px;
    height: 20px;
    flex-shrink: 0;
  }

  .switch input { opacity: 0; width: 0; height: 0; position: absolute; }

  .switch .slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: #ccc;
    border-radius: 20px;
    transition: 0.2s;
  }

  .switch .slider::before {
    content: '';
    position: absolute;
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.2s;
  }

  .switch input:checked + .slider { background: var(--tag-active); }
  .switch input:checked + .slider::before { transform: translateX(16px); }

  .settings-hint {
    font-size: 9px;
    color: var(--ink-light);
    padding: 2px 0 0;
  }

  .line-date {
    width: 46px;
    border: none;
    background: transparent;
    font-family: Arial, sans-serif;
    font-size: 13px;
    color: var(--ink-light);
    text-align: center;
    outline: none;
    height: var(--line-h);
    line-height: var(--line-h);
    padding: 0;
    flex-shrink: 0;
  }

  .line-date::placeholder { color: #d0ccc0; }

  .line-tag-btn {
    width: 48px;
    padding: 1px 3px;
    font-size: 9px;
    border-radius: 5px;
    border: 1px dashed #ccc;
    background: transparent;
    color: var(--ink-light);
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center;
    transition: all 0.12s;
    flex-shrink: 0;
    font-family: Arial, sans-serif;
    height: 20px;
    line-height: 16px;
    margin-top: calc((var(--line-h) - 20px) / 2);
  }

  .line-tag-btn:hover { border-color: var(--tag-active); color: var(--tag-active); background: var(--tag-bg); }
  .line-tag-btn.has-tag { font-weight: 500; border-style: solid; }
  .line-tag-btn.has-tag:hover { opacity: 0.8; }

  .line-text {
    flex: 1;
    width: 0;
    border: none;
    background: transparent;
    font-family: Arial, sans-serif;
    font-size: 18px;
    color: var(--ink);
    outline: none;
    min-height: var(--line-h);
    line-height: var(--line-h);
    padding: 0 4px;
    min-width: 0;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
  }

  .line-del {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    cursor: pointer;
    border: none;
    background: transparent;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 3px;
    font-size: 13px;
    line-height: 1;
    color: #d0ccc0;
    margin-top: calc((var(--line-h) - 20px) / 2);
    opacity: 0;
    transition: opacity 0.15s, color 0.15s;
  }

  .line-row:hover .line-del { opacity: 0.6; }
  .line-del:hover { opacity: 1 !important; color: var(--accent); }

  .line-text:empty::before {
    content: attr(data-placeholder);
    color: #d5d0c5;
    pointer-events: none;
  }

  .line-text b, .line-text strong { font-weight: 700; }

  .bold-btn {
    font-size: 13px;
    font-weight: 700;
    color: var(--ink-light);
    background: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 2px 8px;
    cursor: pointer;
    opacity: 0.5;
    transition: all 0.15s;
    font-family: Arial, sans-serif;
    margin-right: 6px;
  }

  .bold-btn:hover { opacity: 1; color: var(--ink); }

  /* --- Page filter bar --- */
  .page-filter-bar {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px 4px 6px;
    border-bottom: 1px solid #e8e4dc;
    background: #faf8f4;
    flex-wrap: nowrap;
    min-height: 30px;
    overflow-x: auto;
  }

  .page-filter-search {
    width: 120px;
    padding: 3px 7px 3px 22px;
    border: 1px solid #d8d0c0;
    border-radius: 5px;
    background: white;
    font-size: 11px;
    color: var(--ink);
    outline: none;
    font-family: Arial, sans-serif;
    position: relative;
  }

  .page-filter-search:focus { border-color: var(--tag-active); }

  .page-filter-search-wrap {
    position: relative;
    display: inline-block;
  }

  .page-filter-search-wrap::before {
    content: '\1F50D';
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    opacity: 0.35;
    z-index: 1;
    pointer-events: none;
  }

  .page-filter-tags {
    display: flex;
    gap: 3px;
    flex-wrap: nowrap;
    align-items: center;
    flex-shrink: 0;
  }

  .page-tag-chip {
    padding: 1px 6px;
    border-radius: 6px;
    background: var(--tag-bg);
    color: var(--ink);
    font-size: 9px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.12s;
    user-select: none;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .page-tag-chip:hover { background: #d0e0f0; }
  .page-tag-chip.active { background: var(--tag-active); color: white; }

  .page-filter-toggle {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 3px;
    font-size: 9px;
    color: var(--ink-light);
    cursor: pointer;
    user-select: none;
    padding: 2px 6px;
    border-radius: 5px;
    border: 1px solid transparent;
    transition: all 0.12s;
    white-space: nowrap;
  }

  .page-filter-toggle:hover { background: #e8e2d5; }
  .page-filter-toggle.active { background: var(--tag-active); color: white; border-color: var(--tag-active); }

  .page-filter-toggle input[type="checkbox"] { display: none; }

  .page-filter-icon {
    font-size: 12px;
    line-height: 1;
  }

  .line-row.filtered-out { display: none; }

  .page-filter-bar .page-filter-clear {
    background: none;
    border: 1px solid #d8d0c0;
    border-radius: 5px;
    font-size: 9px;
    color: var(--ink-light);
    cursor: pointer;
    padding: 2px 6px;
    transition: all 0.12s;
    display: none;
  }

  .page-filter-bar .page-filter-clear.visible { display: inline-block; }
  .page-filter-bar .page-filter-clear:hover { color: var(--accent); border-color: var(--accent); }

  .paper-footer {
    padding: 6px 16px;
    text-align: center;
    font-size: 10px;
    color: var(--ink-light);
    min-height: 28px;
  }

  /* Tag dropdown */
  .tag-dropdown {
    position: fixed;
    z-index: 300;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    min-width: 180px;
    max-width: 230px;
    display: none;
    overflow: hidden;
  }

  .tag-dropdown.open { display: block; }

  .tag-dd-search {
    width: 100%;
    padding: 8px 10px;
    border: none;
    border-bottom: 1px solid #eee;
    font-size: 12px;
    outline: none;
    background: #fafafa;
  }

  .tag-dd-search::placeholder { color: #bbb; }

  .tag-dd-list { max-height: 170px; overflow-y: auto; padding: 2px 0; }

  .tag-dd-item {
    padding: 6px 10px;
    font-size: 11px;
    cursor: pointer;
    transition: background 0.08s;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .tag-dd-item:hover, .tag-dd-item.hl { background: var(--tag-bg); }
  .tag-dd-item.create { color: var(--tag-active); font-weight: 500; }
  .tag-dd-item.remove { color: var(--accent); border-top: 1px solid #eee; }
  .tag-dd-empty { padding: 10px; font-size: 10px; color: #aaa; text-align: center; }

  .tag-dd-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--tag-active);
    flex-shrink: 0;
  }

  .tag-dd-colors {
    display: none;
    gap: 4px;
    padding: 8px 10px;
    border-top: 1px solid #eee;
    align-items: center;
    flex-wrap: wrap;
  }

  .tag-dd-colors.visible { display: flex; }

  .tag-dd-colors-label {
    font-size: 9px;
    color: var(--ink-light);
    margin-right: 2px;
  }

  .tag-dd-color {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.12s;
  }

  .tag-dd-color:hover { transform: scale(1.2); }
  .tag-dd-color.active { border-color: #333; box-shadow: 0 0 0 1px white inset; }

  /* Page turn animation */
  .lines-area.turn-left { animation: turnL 0.22s ease; }
  .lines-area.turn-right { animation: turnR 0.22s ease; }

  @keyframes turnL {
    0% { opacity: 0; transform: translateX(-20px); }
    100% { opacity: 1; transform: translateX(0); }
  }

  @keyframes turnR {
    0% { opacity: 0; transform: translateX(20px); }
    100% { opacity: 1; transform: translateX(0); }
  }

  /* Mobile */
  .menu-btn {
    display: none;
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 100;
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: rgba(255,255,255,0.85);
    border: none;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 1px 6px var(--shadow);
  }

  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 98;
  }

  .overlay.visible { display: block; }

  @media (max-width: 768px) {
    :root { --line-h: 32px; }

    .sidebar {
      position: fixed;
      left: -100%;
      top: 0;
      z-index: 99;
      width: 80%;
      max-width: 280px;
      transition: left 0.3s;
      box-shadow: 4px 0 12px var(--shadow);
    }

    .sidebar.open { left: 0; }
    .menu-btn { display: flex; align-items: center; justify-content: center; }

    .notebook-area { padding: 8px 44px; }

    .paper::before { left: 100px; }
    .line-todo { width: 16px; height: 16px; font-size: 13px; }
    .line-prio { width: 20px; height: 18px; font-size: 9px; }
    .line-date { width: 38px; font-size: 11px; }
    .line-tag-btn { width: 40px; font-size: 8px; }
    .line-text { font-size: 16px; }
    .page-filter-search { width: 90px; font-size: 10px; }
    .page-filter-toggle { font-size: 8px; }
    .page-tag-chip { font-size: 8px; }

    .page-arrow { width: 34px; height: 34px; font-size: 18px; }
    .page-arrow-left { left: 4px; }
    .page-arrow-right { right: 4px; }
  }

  @media (max-width: 400px) {
    :root { --line-h: 30px; }
    .line-date { width: 34px; font-size: 10px; }
    .line-tag-btn { width: 36px; font-size: 7px; }
    .paper::before { left: 88px; }
    .line-todo { width: 14px; height: 14px; font-size: 11px; }
    .line-prio { width: 18px; height: 16px; font-size: 8px; }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #c8c0b0; border-radius: 2px; }

  input[type="file"] { display: none; }
</style>
</head>
<body>

<div class="app" style="display:flex;width:100%;height:100vh;">

<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h1>Mein Notizbuch</h1>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Suchen..." autocomplete="off">
    </div>
  </div>

  <div class="tags-section">
    <h3>Tags</h3>
    <div class="tag-filters" id="tagFilters"></div>
  </div>

  <div class="sidebar-actions">
    <button class="sb-btn primary" id="newPageBtn">+ Neue Seite</button>
    <button class="sb-btn" id="fileSyncBtn">Datei verknuepfen</button>
    <div class="file-status" id="fileStatus"></div>
    <div style="display:flex;gap:6px">
      <button class="sb-btn" id="exportBtn" style="flex:1">Export</button>
      <button class="sb-btn" id="importBtn" style="flex:1">Import</button>
    </div>
  </div>
  <input type="file" id="importFile" accept=".json">

  <div class="sidebar-tabs">
    <button class="sidebar-tab active" data-tab="pages" id="tabPages">Seiten</button>
    <button class="sidebar-tab" data-tab="todos" id="tabTodos">ToDos</button>
  </div>

  <div class="page-list" id="pageList"></div>
  <div class="pg-count" id="pgCount"></div>

  <div class="sidebar-bottom">
    <div class="settings-section" id="settingsSection">
      <div class="settings-toggle" id="settingsToggle">
        <span>&#9881; Einstellungen</span>
        <span id="settingsArrow">&#9656;</span>
      </div>
      <div class="settings-body" id="settingsBody">
        <div class="settings-row">
          <label for="reminderEnabled">Erinnerung</label>
          <label class="switch">
            <input type="checkbox" id="reminderEnabled">
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <label for="reminderTime">Uhrzeit</label>
          <input type="time" id="reminderTime" value="08:00">
        </div>
        <div class="settings-hint" id="reminderHint"></div>
      </div>
    </div>

    <div class="version-info" id="versionInfo"></div>
  </div>

  <div class="todo-section" id="todoSection">
    <div class="todo-filters" id="todoFilters"></div>
    <div class="todo-tag-filters" id="todoTagFilters"></div>
    <div class="todo-list" id="todoList"></div>
    <div class="todo-count" id="todoCount"></div>
  </div>
</aside>

<main class="notebook-area" id="notebookArea">
  <button class="page-arrow page-arrow-left" id="prevBtn">&#8249;</button>

  <div class="paper" id="paper">
    <div class="paper-header">
      <span class="paper-page-info" id="pageInfo">Seite 1</span>
      <div>
        <button class="bold-btn" id="boldBtn" title="Fett (Strg+B)"><b>B</b></button>
        <button class="paper-del-btn" id="delPageBtn">Seite entfernen</button>
      </div>
    </div>
    <div class="page-filter-bar" id="pageFilterBar">
      <div class="page-filter-search-wrap">
        <input type="text" class="page-filter-search" id="pageFilterSearch" placeholder="Zeilen filtern..." autocomplete="off">
      </div>
      <div class="page-filter-tags" id="pageFilterTags"></div>
      <button class="page-filter-clear" id="pageFilterClear" title="Filter zuruecksetzen">&#10005; Reset</button>
      <label class="page-filter-toggle" id="pageFilterHideDone" title="Erledigte ToDos ausblenden">
        <input type="checkbox" id="hideDoneCheck">
        <span class="page-filter-icon">&#9745;</span> Erledigte ausblenden
      </label>
    </div>
    <div class="lines-area" id="linesArea"></div>
    <div class="paper-footer" id="pageFooter">Seite 1 von 1</div>
  </div>

  <button class="page-arrow page-arrow-right" id="nextBtn">&#8250;</button>
</main>

</div>

<button class="menu-btn" id="menuBtn">&#9776;</button>
<div class="overlay" id="overlay"></div>

<div class="tag-dropdown" id="tagDd">
  <input type="text" class="tag-dd-search" id="tagDdSearch" placeholder="Tag eingeben..." autocomplete="off">
  <div class="tag-dd-list" id="tagDdList"></div>
  <div class="tag-dd-colors" id="tagDdColors"></div>
</div>

<script>
(function() {
  const APP_VERSION = 'v1.0.0';
  const BUILD_DATE = '24.02.2026 – 14:00';
  const LINES_PER_PAGE = 18;

  // --- State ---
  let pages = [];
  let curPage = 0;
  let activeTagFilter = null;
  let searchQuery = '';
  let saveTimer = null;
  let ddLineIdx = null;
  let ddHlIdx = -1;
  let activeTab = 'pages'; // 'pages' or 'todos'
  let todoFilter = 'open'; // 'open', 'done', 'all'
  let todoTagFilter = null;
  let pageLineSearch = '';
  let pageLineTagFilter = null;
  let hideDoneTodos = false;

  // Reminder state
  let reminderEnabled = false;
  let reminderTime = '08:00';
  let reminderLastShown = '';
  let reminderInterval = null;

  // --- Elements ---
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  const menuBtn = document.getElementById('menuBtn');
  const searchInput = document.getElementById('searchInput');
  const tagFilters = document.getElementById('tagFilters');
  const pageList = document.getElementById('pageList');
  const pgCount = document.getElementById('pgCount');
  const newPageBtn = document.getElementById('newPageBtn');
  const linesArea = document.getElementById('linesArea');
  const pageInfo = document.getElementById('pageInfo');
  const pageFooter = document.getElementById('pageFooter');
  const delPageBtn = document.getElementById('delPageBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const paper = document.getElementById('paper');
  const boldBtn = document.getElementById('boldBtn');
  const tagDd = document.getElementById('tagDd');
  const tagDdSearch = document.getElementById('tagDdSearch');
  const tagDdList = document.getElementById('tagDdList');
  const tabPages = document.getElementById('tabPages');
  const tabTodos = document.getElementById('tabTodos');
  const todoSection = document.getElementById('todoSection');
  const todoFilters = document.getElementById('todoFilters');
  const todoTagFilters = document.getElementById('todoTagFilters');
  const todoList = document.getElementById('todoList');
  const todoCount = document.getElementById('todoCount');
  const fileSyncBtn = document.getElementById('fileSyncBtn');
  const fileStatus = document.getElementById('fileStatus');
  const pageFilterSearch = document.getElementById('pageFilterSearch');
  const pageFilterTags = document.getElementById('pageFilterTags');
  const pageFilterClear = document.getElementById('pageFilterClear');
  const hideDoneCheck = document.getElementById('hideDoneCheck');
  const pageFilterHideDone = document.getElementById('pageFilterHideDone');

  // --- File System Access API ---
  let fileHandle = null;

  function updateFileSyncUI() {
    if (fileHandle) {
      fileSyncBtn.textContent = 'Datei trennen';
      fileSyncBtn.classList.add('file-linked');
      fileStatus.textContent = fileHandle.name;
      fileStatus.classList.add('active');
    } else {
      fileSyncBtn.textContent = 'Datei verknuepfen';
      fileSyncBtn.classList.remove('file-linked');
      fileStatus.textContent = '';
      fileStatus.classList.remove('active');
    }
  }

  async function saveToFile() {
    if (!fileHandle) return;
    try {
      const writable = await fileHandle.createWritable();
      await writable.write(JSON.stringify(pages, null, 2));
      await writable.close();
    } catch (err) {
      console.warn('Datei-Sync fehlgeschlagen:', err);
      fileHandle = null;
      updateFileSyncUI();
    }
  }

  async function connectFile() {
    if (!window.showSaveFilePicker) {
      alert('Dein Browser unterstuetzt die File System Access API nicht. Bitte verwende Chrome oder Edge.');
      return;
    }
    try {
      fileHandle = await window.showSaveFilePicker({
        suggestedName: 'notizbuch.json',
        types: [{
          description: 'JSON Datei',
          accept: { 'application/json': ['.json'] }
        }]
      });
      await saveToFile();
      updateFileSyncUI();
    } catch (err) {
      if (err.name !== 'AbortError') console.warn('Datei-Verknuepfung abgebrochen:', err);
    }
  }

  async function loadFromFile() {
    if (!window.showOpenFilePicker) {
      alert('Dein Browser unterstuetzt die File System Access API nicht. Bitte verwende Chrome oder Edge.');
      return;
    }
    try {
      const [handle] = await window.showOpenFilePicker({
        types: [{
          description: 'JSON Datei',
          accept: { 'application/json': ['.json'] }
        }]
      });
      const file = await handle.getFile();
      const text = await file.text();
      const imp = JSON.parse(text);
      if (!Array.isArray(imp)) { alert('Ungueltige Datei.'); return; }
      pages = imp;
      curPage = 0;
      fileHandle = handle;
      save();
      updateFileSyncUI();
      renderTags();
      renderPage();
      renderPageList();
    } catch (err) {
      if (err.name !== 'AbortError') { alert('Fehler: ' + err.message); }
    }
  }

  function disconnectFile() {
    fileHandle = null;
    updateFileSyncUI();
  }

  fileSyncBtn.addEventListener('click', async () => {
    if (fileHandle) {
      disconnectFile();
    } else {
      // Ask user: new file or open existing
      const choice = confirm('Neue Datei anlegen?\n\nOK = Neue Datei erstellen\nAbbrechen = Bestehende Datei oeffnen');
      if (choice) {
        await connectFile();
      } else {
        await loadFromFile();
      }
    }
  });

  // --- Tag color palette ---
  const TAG_PALETTE = [
    { bg: '#e8f5e9', text: '#2e7d32' },
    { bg: '#e3f2fd', text: '#1565c0' },
    { bg: '#fce4ec', text: '#c62828' },
    { bg: '#fff3e0', text: '#e65100' },
    { bg: '#f3e5f5', text: '#7b1fa2' },
    { bg: '#e0f2f1', text: '#00695c' },
    { bg: '#fff9c4', text: '#f57f17' },
    { bg: '#e8eaf6', text: '#283593' },
    { bg: '#fbe9e7', text: '#bf360c' },
    { bg: '#f1f8e9', text: '#558b2f' },
  ];

  let tagColorMap = {};

  function loadTagColors() {
    const raw = localStorage.getItem('notizbuch_tag_colors');
    if (raw) tagColorMap = JSON.parse(raw);
  }

  function saveTagColors() {
    localStorage.setItem('notizbuch_tag_colors', JSON.stringify(tagColorMap));
  }

  function tagColorIndex(name) {
    if (!name) return 0;
    if (tagColorMap[name] !== undefined) return tagColorMap[name] % TAG_PALETTE.length;
    let h = 0;
    for (let i = 0; i < name.length; i++) h = ((h << 5) - h + name.charCodeAt(i)) | 0;
    return Math.abs(h) % TAG_PALETTE.length;
  }

  function tagColor(name) {
    if (!name) return null;
    return TAG_PALETTE[tagColorIndex(name)];
  }

  // --- Helpers ---
  function genId() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
  }

  function save() {
    localStorage.setItem('notizbuch_pages', JSON.stringify(pages));
    saveToFile();
  }

  function scheduleSave() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(save, 400);
  }

  function todayStr() {
    const d = new Date();
    return String(d.getDate()).padStart(2, '0') + '.' + String(d.getMonth() + 1).padStart(2, '0') + '.';
  }

  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function stripHtml(html) {
    return html.replace(/<[^>]*>/g, '');
  }

  function isCursorAtStart(el) {
    const sel = window.getSelection();
    if (!sel.rangeCount) return true;
    const range = sel.getRangeAt(0);
    if (!range.collapsed) return false;
    const preRange = document.createRange();
    preRange.selectNodeContents(el);
    preRange.setEnd(range.startContainer, range.startOffset);
    return preRange.toString().length === 0;
  }

  function emptyPage() {
    const lines = [];
    for (let i = 0; i < LINES_PER_PAGE; i++) lines.push({ text: '', tag: '', date: '', todo: false, done: false, priority: '' });
    return { id: genId(), lines, createdAt: Date.now(), updatedAt: Date.now() };
  }

  function dateShort(ts) {
    const d = new Date(ts);
    return String(d.getDate()).padStart(2, '0') + '.' + String(d.getMonth() + 1).padStart(2, '0') + '.';
  }

  // --- Load & Migrate ---
  function load() {
    const raw = localStorage.getItem('notizbuch_pages');
    if (raw) {
      pages = JSON.parse(raw);
      // Migrate: add priority field if missing
      let migrated = false;
      pages.forEach(p => p.lines.forEach(l => {
        if (l.priority === undefined) { l.priority = ''; migrated = true; }
      }));
      if (migrated) save();
      return;
    }

    // Migrate from old format
    const oldRaw = localStorage.getItem('notizbuch_notes');
    if (oldRaw) {
      const oldNotes = JSON.parse(oldRaw);
      oldNotes.forEach(n => {
        const src = n.lines || (n.content || '').split('\n').map(t => ({ text: t, tag: '' }));
        const ds = dateShort(n.createdAt || Date.now());
        const allLines = src.map(l => ({ text: l.text || '', tag: l.tag || '', date: l.date || ds, todo: !!l.done, done: !!l.done }));

        // Split into pages of LINES_PER_PAGE
        for (let i = 0; i < allLines.length; i += LINES_PER_PAGE) {
          const chunk = allLines.slice(i, i + LINES_PER_PAGE);
          while (chunk.length < LINES_PER_PAGE) chunk.push({ text: '', tag: '', date: '', todo: false, done: false });
          pages.push({
            id: (i === 0 ? n.id : genId()),
            lines: chunk,
            createdAt: n.createdAt || Date.now(),
            updatedAt: n.updatedAt || Date.now()
          });
        }
      });
    }

    // Migrate: add todo + done + priority fields
    pages.forEach(p => p.lines.forEach(l => {
      if (l.todo === undefined) l.todo = !!l.done;
      if (l.done === undefined) l.done = false;
      if (l.priority === undefined) l.priority = '';
    }));

    if (pages.length === 0) pages = [emptyPage()];
    save();
  }

  // --- Tag helpers ---
  function allTags() {
    const m = {};
    pages.forEach(p => p.lines.forEach(l => { if (l.tag) m[l.tag] = (m[l.tag] || 0) + 1; }));
    return Object.entries(m).sort((a, b) => b[1] - a[1]);
  }

  function allTagNames() {
    const s = new Set();
    pages.forEach(p => p.lines.forEach(l => { if (l.tag) s.add(l.tag); }));
    return [...s].sort();
  }

  function pageTags(p) {
    return [...new Set(p.lines.map(l => l.tag).filter(Boolean))];
  }

  function pagePreview(p) {
    const f = p.lines.find(l => stripHtml(l.text).trim());
    return f ? stripHtml(f.text).trim().slice(0, 55) : 'Leere Seite';
  }

  function pageDateRange(p) {
    const dates = p.lines.filter(l => l.date && l.text.trim()).map(l => l.date);
    if (!dates.length) return '';
    const u = [...new Set(dates)];
    return u.length === 1 ? u[0] : u[0] + ' – ' + u[u.length - 1];
  }

  function filteredIndices() {
    let idx = pages.map((_, i) => i);
    if (activeTagFilter) idx = idx.filter(i => pages[i].lines.some(l => l.tag === activeTagFilter));
    if (searchQuery.trim()) {
      const q = searchQuery.toLowerCase();
      idx = idx.filter(i => pages[i].lines.some(l => stripHtml(l.text).toLowerCase().includes(q) || l.tag.toLowerCase().includes(q)));
    }
    return idx;
  }

  // --- Render sidebar ---
  function renderTags() {
    const tags = allTags();
    let h = `<span class="tag-chip ${!activeTagFilter ? 'active' : ''}" data-t="">Alle<span class="tc">${pages.length}</span></span>`;
    tags.forEach(([t, c]) => {
      const col = tagColor(t);
      const style = activeTagFilter === t ? '' : `style="background:${col.bg};color:${col.text}"`;
      h += `<span class="tag-chip ${activeTagFilter === t ? 'active' : ''}" data-t="${esc(t)}" ${style}>${esc(t)}<span class="tc">${c}</span></span>`;
    });
    tagFilters.innerHTML = h;
    tagFilters.querySelectorAll('.tag-chip').forEach(el => {
      el.addEventListener('click', () => {
        activeTagFilter = el.dataset.t || null;
        renderTags();
        renderPageList();
      });
    });
  }

  function renderPageList() {
    const idx = filteredIndices();
    if (!idx.length) {
      pageList.innerHTML = '<div style="padding:14px;text-align:center;color:#aaa;font-size:11px;">Keine Seiten</div>';
    } else {
      pageList.innerHTML = idx.map(i => {
        const p = pages[i];
        const tags = pageTags(p).map(t => { const c = tagColor(t); return `<span class="pg-item-tag" style="background:${c.bg};color:${c.text}">${esc(t)}</span>`; }).join('');
        return `<div class="pg-item ${i === curPage ? 'active' : ''}" data-i="${i}">
          <div class="pg-item-preview">Seite ${i + 1}</div>
          <div class="pg-item-meta"><span class="pg-item-date">${pageDateRange(p)}</span>${tags}</div>
        </div>`;
      }).join('');
    }
    pgCount.textContent = `${idx.length} von ${pages.length} Seiten`;
    pageList.querySelectorAll('.pg-item').forEach(el => {
      el.addEventListener('click', () => { goTo(+el.dataset.i); closeSidebar(); });
    });
  }

  // --- Page line filter ---
  function renderPageFilterTags() {
    const pg = pages[curPage];
    if (!pg) return;
    const tags = [...new Set(pg.lines.map(l => l.tag).filter(Boolean))].sort();
    if (!tags.length) {
      pageFilterTags.innerHTML = '';
      return;
    }
    let h = `<span class="page-tag-chip ${!pageLineTagFilter ? 'active' : ''}" data-t="">Alle</span>`;
    tags.forEach(t => {
      const col = tagColor(t);
      const style = pageLineTagFilter === t ? '' : `style="background:${col.bg};color:${col.text}"`;
      h += `<span class="page-tag-chip ${pageLineTagFilter === t ? 'active' : ''}" data-t="${esc(t)}" ${style}>${esc(t)}</span>`;
    });
    pageFilterTags.innerHTML = h;
    pageFilterTags.querySelectorAll('.page-tag-chip').forEach(el => {
      el.addEventListener('click', () => {
        pageLineTagFilter = el.dataset.t || null;
        renderPageFilterTags();
        applyLineFilters();
      });
    });
  }

  function applyLineFilters() {
    const pg = pages[curPage];
    if (!pg) return;
    const rows = linesArea.querySelectorAll('.line-row');
    const q = pageLineSearch.trim().toLowerCase();
    const hasFilter = q || pageLineTagFilter || hideDoneTodos;
    pageFilterClear.classList.toggle('visible', hasFilter);

    rows.forEach((row, i) => {
      const line = pg.lines[i];
      if (!line) return;
      let visible = true;

      // Hide done todos
      if (hideDoneTodos && line.todo && line.done) {
        visible = false;
      }

      // Tag filter
      if (visible && pageLineTagFilter) {
        if (line.tag !== pageLineTagFilter) visible = false;
      }

      // Search filter (text + tag)
      if (visible && q) {
        const text = stripHtml(line.text).toLowerCase();
        const tag = (line.tag || '').toLowerCase();
        if (!text.includes(q) && !tag.includes(q)) visible = false;
      }

      row.classList.toggle('filtered-out', !visible);
    });
  }

  function resetPageFilters() {
    pageLineSearch = '';
    pageLineTagFilter = null;
    hideDoneTodos = false;
    pageFilterSearch.value = '';
    hideDoneCheck.checked = false;
    pageFilterHideDone.classList.remove('active');
    renderPageFilterTags();
    applyLineFilters();
  }

  // --- Render paper ---
  function renderPage(dir) {
    const pg = pages[curPage];
    if (!pg) return;

    if (dir) {
      linesArea.classList.remove('turn-left', 'turn-right');
      void linesArea.offsetWidth;
      linesArea.classList.add(dir === 'left' ? 'turn-left' : 'turn-right');
    }

    pageInfo.textContent = 'Seite ' + (curPage + 1);
    pageFooter.textContent = 'Seite ' + (curPage + 1) + ' von ' + pages.length;
    prevBtn.disabled = curPage <= 0;
    nextBtn.disabled = false;

    linesArea.innerHTML = '';
    pg.lines.forEach((line, i) => {
      const row = document.createElement('div');
      row.className = 'line-row';

      const todoBtn = document.createElement('button');
      todoBtn.type = 'button';
      todoBtn.className = 'line-todo' + (line.todo ? (line.done ? ' is-done' : ' is-todo') : '');
      todoBtn.innerHTML = line.todo ? (line.done ? '&#9745;' : '&#9744;') : '';
      todoBtn.title = line.todo ? (line.done ? 'Erledigt (klick: zuruecksetzen)' : 'Offen (klick: abhaken)') : 'Klick: als ToDo markieren';

      // Priority button (only visible for todo lines)
      const prioBtn = document.createElement('button');
      prioBtn.type = 'button';
      const prioClass = line.priority ? ' prio-' + line.priority.toLowerCase() : ' prio-none';
      prioBtn.className = 'line-prio' + (line.todo ? ' visible' : '') + prioClass;
      prioBtn.textContent = line.priority || '\u2013';
      prioBtn.title = line.todo ? 'Prioritaet: ' + (line.priority || 'keine') + ' (klick: aendern)' : '';

      const dateIn = document.createElement('input');
      dateIn.type = 'text';
      dateIn.className = 'line-date';
      dateIn.value = line.date;
      dateIn.placeholder = '';
      dateIn.maxLength = 6;

      const tagBtn = document.createElement('button');
      tagBtn.type = 'button';
      tagBtn.className = 'line-tag-btn' + (line.tag ? ' has-tag' : '');
      tagBtn.textContent = line.tag || '#';
      if (line.tag) {
        const tc = tagColor(line.tag);
        tagBtn.style.background = tc.bg;
        tagBtn.style.borderColor = tc.text;
        tagBtn.style.color = tc.text;
      }

      const textIn = document.createElement('div');
      textIn.contentEditable = 'true';
      textIn.className = 'line-text' + (line.todo && line.done ? ' done' : '');
      textIn.innerHTML = line.text;
      if (i === 0 && !pg.lines.some(l => stripHtml(l.text).trim())) textIn.dataset.placeholder = 'Schreibe hier...';

      // Events: 3-state cycle (none → todo → done → none)
      todoBtn.addEventListener('click', () => {
        const l = pg.lines[i];
        if (!l.todo) {
          l.todo = true; l.done = false;
        } else if (!l.done) {
          l.done = true;
        } else {
          l.todo = false; l.done = false; l.priority = '';
        }
        todoBtn.className = 'line-todo' + (l.todo ? (l.done ? ' is-done' : ' is-todo') : '');
        todoBtn.innerHTML = l.todo ? (l.done ? '&#9745;' : '&#9744;') : '';
        todoBtn.title = l.todo ? (l.done ? 'Erledigt (klick: zuruecksetzen)' : 'Offen (klick: abhaken)') : 'Klick: als ToDo markieren';
        textIn.classList.toggle('done', l.todo && l.done);
        // Update priority button visibility
        prioBtn.classList.toggle('visible', l.todo);
        if (!l.todo) {
          prioBtn.className = 'line-prio';
          prioBtn.textContent = '\u2013';
        } else if (!l.priority) {
          prioBtn.className = 'line-prio visible prio-none';
          prioBtn.textContent = '\u2013';
        }
        pg.updatedAt = Date.now();
        save();
        if (activeTab === 'todos') { renderTodoFilters(); renderTodoList(); }
        renderPageList();
      });

      // Priority cycle: none → A → B → C → none
      prioBtn.addEventListener('click', () => {
        const l = pg.lines[i];
        if (!l.todo) return;
        const cycle = ['', 'A', 'B', 'C'];
        const idx = cycle.indexOf(l.priority || '');
        l.priority = cycle[(idx + 1) % cycle.length];
        const pc = l.priority ? ' prio-' + l.priority.toLowerCase() : ' prio-none';
        prioBtn.className = 'line-prio visible' + pc;
        prioBtn.textContent = l.priority || '\u2013';
        prioBtn.title = 'Prioritaet: ' + (l.priority || 'keine') + ' (klick: aendern)';
        pg.updatedAt = Date.now();
        save();
        if (activeTab === 'todos') renderTodoList();
      });

      dateIn.addEventListener('input', () => {
        pg.lines[i].date = dateIn.value;
        pg.updatedAt = Date.now();
        scheduleSave();
      });

      textIn.addEventListener('input', () => {
        if (textIn.innerHTML === '<br>' || textIn.innerHTML === '<br/>') textIn.innerHTML = '';
        pg.lines[i].text = textIn.innerHTML;
        if (textIn.textContent.trim() && !pg.lines[i].date) {
          pg.lines[i].date = todayStr();
          dateIn.value = pg.lines[i].date;
        }
        pg.updatedAt = Date.now();
        scheduleSave();
        renderPageList();
        if (activeTab === 'todos') renderTodoList();
      });

      textIn.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        document.execCommand('insertText', false, text);
      });

      textIn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (i < LINES_PER_PAGE - 1) {
            focusLine(i + 1);
          } else {
            if (curPage < pages.length - 1) {
              goTo(curPage + 1, 'right');
              setTimeout(() => focusLine(0), 250);
            } else {
              addPage();
              setTimeout(() => focusLine(0), 250);
            }
          }
        } else if (e.key === 'Backspace' && isCursorAtStart(textIn)) {
          if (!textIn.textContent.trim() && !pg.lines[i].date && !pg.lines[i].tag && i > 0) {
            e.preventDefault();
            focusLine(i - 1, 'end');
          } else if (i === 0 && !textIn.textContent.trim() && curPage > 0) {
            e.preventDefault();
            goTo(curPage - 1, 'left');
            setTimeout(() => focusLine(LINES_PER_PAGE - 1, 'end'), 250);
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (i > 0) focusLine(i - 1);
          else if (curPage > 0) {
            goTo(curPage - 1, 'left');
            setTimeout(() => focusLine(LINES_PER_PAGE - 1), 250);
          }
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (i < LINES_PER_PAGE - 1) focusLine(i + 1);
          else if (curPage < pages.length - 1) {
            goTo(curPage + 1, 'right');
            setTimeout(() => focusLine(0), 250);
          }
        } else if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
          e.preventDefault();
          document.execCommand('bold');
        }
      });

      tagBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openTagDd(i, tagBtn);
      });

      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'line-del';
      delBtn.innerHTML = '&#128465;';
      delBtn.title = 'Zeile loeschen';

      delBtn.addEventListener('click', () => {
        const l = pg.lines[i];
        if (!stripHtml(l.text).trim() && !l.date && !l.tag && !l.todo) return;
        l.text = '';
        l.date = '';
        l.tag = '';
        l.todo = false;
        l.done = false;
        l.priority = '';
        pg.updatedAt = Date.now();
        save();
        renderPage();
        renderTags();
        renderPageList();
        if (activeTab === 'todos') { renderTodoFilters(); renderTodoList(); }
      });

      row.appendChild(todoBtn);
      row.appendChild(prioBtn);
      row.appendChild(dateIn);
      row.appendChild(tagBtn);
      row.appendChild(textIn);
      row.appendChild(delBtn);
      linesArea.appendChild(row);
    });

    renderPageFilterTags();
    applyLineFilters();
    renderPageList();
  }

  function focusLine(idx, pos) {
    requestAnimationFrame(() => {
      const rows = linesArea.querySelectorAll('.line-row');
      if (!rows[idx]) return;
      const el = rows[idx].querySelector('.line-text');
      el.focus();
      if (pos === 'end' && el.childNodes.length > 0) {
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(el);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
      }
    });
  }

  // --- Navigation ---
  function goTo(idx, dir) {
    if (idx < 0 || idx >= pages.length) return;
    curPage = idx;
    closeTagDd();
    renderPage(dir);
  }

  function addPage() {
    pages.push(emptyPage());
    curPage = pages.length - 1;
    save();
    renderPage('right');
    renderTags();
  }

  function deletePage() {
    if (pages.length <= 1) {
      pages[0] = emptyPage();
      save();
      renderPage();
      renderTags();
      renderPageList();
      return;
    }
    if (!confirm('Diese Seite wirklich entfernen?')) return;
    pages.splice(curPage, 1);
    if (curPage >= pages.length) curPage = pages.length - 1;
    save();
    renderPage();
    renderTags();
    renderPageList();
  }

  // --- Tag dropdown ---
  function openTagDd(lineIdx, btn) {
    ddLineIdx = lineIdx;
    ddHlIdx = -1;
    const r = btn.getBoundingClientRect();
    tagDd.style.top = (r.bottom + 4) + 'px';
    tagDd.style.left = Math.max(4, Math.min(r.left, window.innerWidth - 200)) + 'px';
    tagDd.classList.add('open');
    tagDdSearch.value = '';
    tagDdSearch.focus();
    renderTagDd('');
  }

  function closeTagDd() {
    tagDd.classList.remove('open');
    ddLineIdx = null;
    ddHlIdx = -1;
  }

  function renderTagDd(query) {
    const all = allTagNames();
    const q = query.trim().toLowerCase();
    const filtered = q ? all.filter(t => t.includes(q)) : all;
    let h = '';

    if (q && !all.includes(q)) {
      const qc = tagColor(q);
      h += `<div class="tag-dd-item create" data-t="${esc(q)}"><span class="tag-dd-dot" style="background:${qc.text}"></span>"${esc(query.trim())}" erstellen</div>`;
    }
    filtered.forEach(t => {
      const tc = tagColor(t);
      h += `<div class="tag-dd-item" data-t="${esc(t)}"><span class="tag-dd-dot" style="background:${tc.text}"></span>${esc(t)}</div>`;
    });

    const pg = pages[curPage];
    if (pg && pg.lines[ddLineIdx] && pg.lines[ddLineIdx].tag) {
      h += `<div class="tag-dd-item remove" data-t="">Tag entfernen</div>`;
    }

    tagDdList.innerHTML = h || '<div class="tag-dd-empty">Tag-Name tippen...</div>';

    tagDdList.querySelectorAll('.tag-dd-item[data-t]').forEach(el => {
      el.addEventListener('click', () => pickTag(el.dataset.t));
    });
    renderTagDdColors();
  }

  function renderTagDdColors() {
    const tagDdColors = document.getElementById('tagDdColors');
    const pg = pages[curPage];
    const currentTag = pg && ddLineIdx !== null && pg.lines[ddLineIdx] ? pg.lines[ddLineIdx].tag : '';

    if (!currentTag) {
      tagDdColors.classList.remove('visible');
      return;
    }

    tagDdColors.classList.add('visible');
    const activeIdx = tagColorIndex(currentTag);
    let h = '<span class="tag-dd-colors-label">Farbe:</span>';
    TAG_PALETTE.forEach((c, i) => {
      h += `<span class="tag-dd-color${i === activeIdx ? ' active' : ''}" style="background:${c.text}" data-ci="${i}"></span>`;
    });
    tagDdColors.innerHTML = h;

    tagDdColors.querySelectorAll('.tag-dd-color').forEach(el => {
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        tagColorMap[currentTag] = +el.dataset.ci;
        saveTagColors();
        renderPage();
        renderTags();
        renderPageList();
        renderTagDdColors();
      });
    });
  }

  function pickTag(tag) {
    const pg = pages[curPage];
    if (!pg || ddLineIdx === null) return;
    pg.lines[ddLineIdx].tag = tag ? tag.trim().toLowerCase() : '';
    pg.updatedAt = Date.now();
    save();
    renderPage();
    renderTags();
    closeTagDd();
  }

  tagDdSearch.addEventListener('input', () => {
    ddHlIdx = -1;
    renderTagDd(tagDdSearch.value);
  });

  tagDdSearch.addEventListener('keydown', (e) => {
    const items = tagDdList.querySelectorAll('.tag-dd-item[data-t]');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      ddHlIdx = Math.min(ddHlIdx + 1, items.length - 1);
      items.forEach((el, i) => el.classList.toggle('hl', i === ddHlIdx));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      ddHlIdx = Math.max(ddHlIdx - 1, 0);
      items.forEach((el, i) => el.classList.toggle('hl', i === ddHlIdx));
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (ddHlIdx >= 0 && items[ddHlIdx]) pickTag(items[ddHlIdx].dataset.t);
      else {
        const v = tagDdSearch.value.trim().toLowerCase();
        if (v) pickTag(v);
      }
    } else if (e.key === 'Escape') {
      closeTagDd();
    }
  });

  document.addEventListener('click', (e) => {
    if (!tagDd.contains(e.target) && !e.target.classList.contains('line-tag-btn')) closeTagDd();
  });

  // --- Tabs ---
  function switchTab(tab) {
    activeTab = tab;
    tabPages.classList.toggle('active', tab === 'pages');
    tabTodos.classList.toggle('active', tab === 'todos');
    pageList.style.display = tab === 'pages' ? '' : 'none';
    document.getElementById('pgCount').style.display = tab === 'pages' ? '' : 'none';
    todoSection.classList.toggle('visible', tab === 'todos');
    if (tab === 'todos') {
      renderTodoFilters();
      renderTodoTagFilters();
      renderTodoList();
    }
  }

  tabPages.addEventListener('click', () => switchTab('pages'));
  tabTodos.addEventListener('click', () => switchTab('todos'));

  // --- ToDo overview ---
  function collectTodos() {
    const items = [];
    pages.forEach((p, pi) => {
      p.lines.forEach((l, li) => {
        if (l.todo) {
          items.push({ text: stripHtml(l.text) || '(leer)', tag: l.tag, date: l.date, done: !!l.done, priority: l.priority || '', pageIdx: pi, lineIdx: li });
        }
      });
    });
    return items;
  }

  function getFilteredTodos() {
    let items = collectTodos();
    if (todoFilter === 'open') items = items.filter(t => !t.done);
    else if (todoFilter === 'done') items = items.filter(t => t.done);
    if (todoTagFilter) items = items.filter(t => t.tag === todoTagFilter);
    return items;
  }

  function getTodoCounts() {
    const all = collectTodos();
    return { open: all.filter(t => !t.done).length, done: all.filter(t => t.done).length, all: all.length };
  }

  function getTodoTags() {
    const m = {};
    collectTodos().forEach(t => { if (t.tag) m[t.tag] = (m[t.tag] || 0) + 1; });
    return Object.entries(m).sort((a, b) => b[1] - a[1]);
  }

  function renderTodoFilters() {
    const c = getTodoCounts();
    const filters = [
      { key: 'open', label: 'Offen', count: c.open },
      { key: 'done', label: 'Erledigt', count: c.done },
      { key: 'all', label: 'Alle', count: c.all }
    ];
    todoFilters.innerHTML = filters.map(f =>
      `<span class="todo-filter ${todoFilter === f.key ? 'active' : ''}" data-f="${f.key}">${f.label}<span class="tf-count">${f.count}</span></span>`
    ).join('');
    todoFilters.querySelectorAll('.todo-filter').forEach(el => {
      el.addEventListener('click', () => {
        todoFilter = el.dataset.f;
        renderTodoFilters();
        renderTodoList();
      });
    });
  }

  function renderTodoTagFilters() {
    const tags = getTodoTags();
    if (!tags.length) { todoTagFilters.style.display = 'none'; return; }
    todoTagFilters.style.display = 'flex';
    let h = `<span class="todo-tag-chip ${!todoTagFilter ? 'active' : ''}" data-t="">Alle Tags</span>`;
    tags.forEach(([t, c]) => {
      const col = tagColor(t);
      const style = todoTagFilter === t ? '' : `style="background:${col.bg};color:${col.text}"`;
      h += `<span class="todo-tag-chip ${todoTagFilter === t ? 'active' : ''}" data-t="${esc(t)}" ${style}>${esc(t)} ${c}</span>`;
    });
    todoTagFilters.innerHTML = h;
    todoTagFilters.querySelectorAll('.todo-tag-chip').forEach(el => {
      el.addEventListener('click', () => {
        todoTagFilter = el.dataset.t || null;
        renderTodoTagFilters();
        renderTodoList();
      });
    });
  }

  function renderTodoList() {
    const items = getFilteredTodos();
    if (!items.length) {
      todoList.innerHTML = '<div style="padding:16px;text-align:center;color:#aaa;font-size:11px;">Keine Eintraege</div>';
    } else {
      todoList.innerHTML = items.map((t, idx) => {
        const tc = t.tag ? tagColor(t.tag) : null;
        const tagH = t.tag ? `<span class="todo-item-tag" style="background:${tc.bg};color:${tc.text}">${esc(t.tag)}</span>` : '';
        const prioH = t.priority ? `<span class="todo-item-prio prio-${t.priority.toLowerCase()}">${t.priority}</span>` : '';
        const icon = t.done ? '&#9745;' : '&#9744;';
        return `<div class="todo-item" data-idx="${idx}">
          <button class="todo-item-check ${t.done ? 'is-done' : ''}" data-pi="${t.pageIdx}" data-li="${t.lineIdx}">${icon}</button>
          <div class="todo-item-content">
            <div class="todo-item-text ${t.done ? 'done' : ''}">${esc(t.text)}</div>
            <div class="todo-item-meta">${prioH} ${t.date || ''} ${tagH} <span class="todo-item-page" data-pi="${t.pageIdx}">S.${t.pageIdx + 1}</span></div>
          </div>
        </div>`;
      }).join('');
    }
    todoCount.textContent = items.length + ' Eintraege';

    // Events: toggle done in todo list
    todoList.querySelectorAll('.todo-item-check').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const pi = +btn.dataset.pi, li = +btn.dataset.li;
        pages[pi].lines[li].done = !pages[pi].lines[li].done;
        pages[pi].updatedAt = Date.now();
        save();
        renderTodoFilters();
        renderTodoList();
        if (pi === curPage) renderPage();
      });
    });

    // Events: click page link → navigate
    todoList.querySelectorAll('.todo-item-page').forEach(el => {
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        const pi = +el.dataset.pi;
        goTo(pi, pi > curPage ? 'right' : 'left');
        closeSidebar();
      });
    });

    // Events: click todo item → navigate to page
    todoList.querySelectorAll('.todo-item').forEach(el => {
      el.addEventListener('click', (e) => {
        if (e.target.classList.contains('todo-item-check')) return;
        const cb = el.querySelector('.todo-item-check');
        const pi = +cb.dataset.pi, li = +cb.dataset.li;
        goTo(pi, pi > curPage ? 'right' : 'left');
        closeSidebar();
        setTimeout(() => focusLine(li), 300);
      });
    });
  }

  // --- Events ---
  newPageBtn.addEventListener('click', () => { addPage(); closeSidebar(); });
  delPageBtn.addEventListener('click', deletePage);
  boldBtn.addEventListener('click', () => { document.execCommand('bold'); });
  prevBtn.addEventListener('click', () => goTo(curPage - 1, 'left'));
  nextBtn.addEventListener('click', () => {
    if (curPage < pages.length - 1) goTo(curPage + 1, 'right');
    else addPage();
  });

  searchInput.addEventListener('input', () => { searchQuery = searchInput.value; renderPageList(); });

  // --- Page filter events ---
  pageFilterSearch.addEventListener('input', () => {
    pageLineSearch = pageFilterSearch.value;
    applyLineFilters();
  });

  hideDoneCheck.addEventListener('change', () => {
    hideDoneTodos = hideDoneCheck.checked;
    pageFilterHideDone.classList.toggle('active', hideDoneTodos);
    applyLineFilters();
  });

  pageFilterClear.addEventListener('click', resetPageFilters);

  menuBtn.addEventListener('click', () => {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('visible');
  });

  overlay.addEventListener('click', closeSidebar);

  function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('visible');
  }

  // --- Swipe ---
  let touchX0 = 0, touchY0 = 0, swiping = false;

  paper.addEventListener('touchstart', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
    touchX0 = e.touches[0].clientX;
    touchY0 = e.touches[0].clientY;
    swiping = true;
  }, { passive: true });

  paper.addEventListener('touchend', (e) => {
    if (!swiping) return;
    swiping = false;
    const dx = e.changedTouches[0].clientX - touchX0;
    const dy = e.changedTouches[0].clientY - touchY0;
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) * 1.5) {
      if (dx < 0) {
        if (curPage < pages.length - 1) goTo(curPage + 1, 'right');
        else addPage();
      } else {
        if (curPage > 0) goTo(curPage - 1, 'left');
      }
    }
  }, { passive: true });

  // --- Keyboard shortcuts ---
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); addPage(); }
    if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowLeft') { e.preventDefault(); if (curPage > 0) goTo(curPage - 1, 'left'); }
    if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowRight') {
      e.preventDefault();
      if (curPage < pages.length - 1) goTo(curPage + 1, 'right');
      else addPage();
    }
  });

  // --- Export / Import ---
  document.getElementById('exportBtn').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(pages, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'notizbuch_' + new Date().toISOString().slice(0, 10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());

  document.getElementById('importFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const imp = JSON.parse(evt.target.result);
        if (!Array.isArray(imp)) { alert('Ungueltige Datei.'); return; }
        const ids = new Set(pages.map(p => p.id));
        let added = 0;
        imp.forEach(p => {
          if (p.id && !ids.has(p.id) && p.lines) { pages.push(p); ids.add(p.id); added++; }
        });
        save();
        renderTags();
        renderPage();
        alert(added + ' Seite(n) importiert.');
      } catch (err) { alert('Fehler: ' + err.message); }
    };
    reader.readAsText(file);
    e.target.value = '';
  });

  // --- Reminder system ---
  function loadReminderSettings() {
    reminderEnabled = localStorage.getItem('notizbuch_reminder_enabled') === 'true';
    reminderTime = localStorage.getItem('notizbuch_reminder_time') || '08:00';
    reminderLastShown = localStorage.getItem('notizbuch_reminder_last_shown') || '';
  }

  function saveReminderSettings() {
    localStorage.setItem('notizbuch_reminder_enabled', reminderEnabled);
    localStorage.setItem('notizbuch_reminder_time', reminderTime);
  }

  function checkReminder() {
    if (!reminderEnabled) return;
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    const current = hh + ':' + mm;
    const today = now.toISOString().slice(0, 10);

    if (current === reminderTime && reminderLastShown !== today) {
      const openTodos = collectTodos().filter(t => !t.done);
      if (openTodos.length > 0) {
        showReminderNotification(openTodos);
        reminderLastShown = today;
        localStorage.setItem('notizbuch_reminder_last_shown', today);
      }
    }
  }

  function showReminderNotification(openTodos) {
    if (!('Notification' in window)) return;
    if (Notification.permission !== 'granted') return;

    const count = openTodos.length;
    const prioA = openTodos.filter(t => t.priority === 'A').length;
    let body = count + ' offene' + (count === 1 ? 's ToDo' : ' ToDos');
    if (prioA > 0) body += ' (' + prioA + ' mit Prio A)';

    // Show up to 3 top items
    const preview = openTodos.slice(0, 3).map(t => {
      const p = t.priority ? '[' + t.priority + '] ' : '';
      return p + t.text;
    }).join('\n');
    body += '\n' + preview;

    new Notification('Notizbuch - Offene ToDos', { body: body });
  }

  function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }

  function startReminderCheck() {
    if (reminderInterval) clearInterval(reminderInterval);
    reminderInterval = setInterval(checkReminder, 60000);
    checkReminder(); // Check immediately on start
  }

  function updateReminderHint() {
    const hint = document.getElementById('reminderHint');
    if (!reminderEnabled) {
      hint.textContent = 'Erinnerung deaktiviert';
    } else if (!('Notification' in window)) {
      hint.textContent = 'Browser unterstuetzt keine Benachrichtigungen';
    } else if (Notification.permission === 'denied') {
      hint.textContent = 'Benachrichtigungen im Browser blockiert';
    } else {
      hint.textContent = 'Taeglich um ' + reminderTime + ' Uhr';
    }
  }

  function initSettings() {
    const toggle = document.getElementById('settingsToggle');
    const body = document.getElementById('settingsBody');
    const arrow = document.getElementById('settingsArrow');
    const enabledCb = document.getElementById('reminderEnabled');
    const timeInput = document.getElementById('reminderTime');

    enabledCb.checked = reminderEnabled;
    timeInput.value = reminderTime;

    toggle.addEventListener('click', () => {
      body.classList.toggle('open');
      arrow.innerHTML = body.classList.contains('open') ? '&#9662;' : '&#9656;';
    });

    enabledCb.addEventListener('change', () => {
      reminderEnabled = enabledCb.checked;
      saveReminderSettings();
      if (reminderEnabled) requestNotificationPermission();
      updateReminderHint();
    });

    timeInput.addEventListener('change', () => {
      reminderTime = timeInput.value;
      saveReminderSettings();
      updateReminderHint();
    });

    updateReminderHint();
  }

  // --- Init ---
  document.getElementById('versionInfo').textContent = APP_VERSION + ' | Build: ' + BUILD_DATE;
  loadTagColors();
  load();
  updateFileSyncUI();
  loadReminderSettings();
  initSettings();
  startReminderCheck();
  renderTags();
  renderPage();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mein Notizbuch</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;600&family=Inter:wght@400;500;600&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --paper: #fffef5;
    --paper-dark: #f5f0e0;
    --line: #c8d4e0;
    --margin: #e8a0a0;
    --ink: #2c3e50;
    --ink-light: #7f8c8d;
    --accent: #e74c3c;
    --accent-hover: #c0392b;
    --tag-bg: #eaf0f7;
    --tag-active: #3498db;
    --shadow: rgba(0,0,0,0.1);
    --sidebar-bg: #f7f4eb;
    --sidebar-width: 280px;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: #e8e0d0;
    color: var(--ink);
    min-height: 100vh;
    display: flex;
  }

  /* --- Sidebar --- */
  .sidebar {
    width: var(--sidebar-width);
    min-width: var(--sidebar-width);
    background: var(--sidebar-bg);
    border-right: 2px solid var(--paper-dark);
    display: flex;
    flex-direction: column;
    height: 100vh;
    position: sticky;
    top: 0;
    overflow-y: auto;
  }

  .sidebar-header {
    padding: 24px 20px 16px;
    border-bottom: 1px solid var(--paper-dark);
  }

  .sidebar-header h1 {
    font-family: 'Caveat', cursive;
    font-size: 28px;
    color: var(--ink);
    margin-bottom: 12px;
  }

  .search-box {
    position: relative;
    margin-bottom: 0;
  }

  .search-box input {
    width: 100%;
    padding: 8px 12px 8px 34px;
    border: 1px solid var(--line);
    border-radius: 8px;
    background: var(--paper);
    font-size: 14px;
    color: var(--ink);
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box input:focus {
    border-color: var(--tag-active);
  }

  .search-box::before {
    content: '\1F50D';
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    opacity: 0.5;
  }

  /* Tags section */
  .tags-section {
    padding: 16px 20px;
    border-bottom: 1px solid var(--paper-dark);
  }

  .tags-section h3 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--ink-light);
    margin-bottom: 10px;
  }

  .tag-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .tag-chip {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 12px;
    background: var(--tag-bg);
    color: var(--ink);
    font-size: 13px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    user-select: none;
  }

  .tag-chip:hover {
    background: #d5e3f0;
  }

  .tag-chip.active {
    background: var(--tag-active);
    color: white;
    border-color: var(--tag-active);
  }

  .tag-chip .tag-count {
    margin-left: 5px;
    font-size: 11px;
    opacity: 0.7;
  }

  .tag-chip-all {
    font-weight: 500;
  }

  /* Notes list */
  .notes-list-section {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }

  .note-item {
    padding: 12px 20px;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.15s;
  }

  .note-item:hover {
    background: var(--paper-dark);
  }

  .note-item.active {
    background: var(--paper);
    border-left-color: var(--tag-active);
  }

  .note-item-title {
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .note-item-preview {
    font-size: 12px;
    color: var(--ink-light);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 6px;
  }

  .note-item-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .note-item-date {
    font-size: 11px;
    color: var(--ink-light);
  }

  .note-item-tag {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 6px;
    background: var(--tag-bg);
    color: var(--ink-light);
  }

  /* New note button */
  .new-note-btn {
    margin: 12px 20px;
    padding: 10px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .new-note-btn:hover {
    background: var(--accent-hover);
  }

  /* --- Main editor --- */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .editor-empty {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--ink-light);
    font-family: 'Caveat', cursive;
    font-size: 24px;
  }

  .editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* Editor toolbar */
  .editor-toolbar {
    display: flex;
    align-items: center;
    padding: 12px 32px;
    background: var(--paper);
    border-bottom: 1px solid var(--paper-dark);
    gap: 12px;
    flex-wrap: wrap;
  }

  .editor-toolbar .tag-input-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
    min-width: 200px;
  }

  .editor-toolbar label {
    font-size: 12px;
    color: var(--ink-light);
    letter-spacing: 0.3px;
    white-space: nowrap;
    font-style: italic;
  }

  .delete-note-btn {
    padding: 6px 12px;
    background: none;
    border: 1px solid var(--margin);
    color: var(--margin);
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .delete-note-btn:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  /* Notebook paper */
  .notebook-page {
    flex: 1;
    background: var(--paper);
    position: relative;
    overflow-y: auto;
  }

  .notebook-page::before {
    content: '';
    position: absolute;
    left: 72px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--margin);
    opacity: 0.5;
    z-index: 1;
    pointer-events: none;
  }

  .title-input {
    width: 100%;
    padding: 24px 32px 8px 88px;
    border: none;
    background: transparent;
    font-family: 'Caveat', cursive;
    font-size: 32px;
    font-weight: 600;
    color: var(--ink);
    outline: none;
    background-image: repeating-linear-gradient(
      transparent,
      transparent 39px,
      var(--line) 39px,
      var(--line) 40px
    );
    background-position-y: 16px;
    line-height: 40px;
  }

  .title-input::placeholder {
    color: #ccc;
  }

  /* Lines editor */
  .lines-editor {
    padding: 8px 16px 32px 88px;
    min-height: calc(100vh - 200px);
    background-image: repeating-linear-gradient(
      transparent,
      transparent 39px,
      var(--line) 39px,
      var(--line) 40px
    );
    background-position-y: 0;
  }

  .line-row {
    display: flex;
    align-items: center;
    height: 40px;
    position: relative;
    gap: 4px;
  }

  .line-text {
    flex: 1;
    border: none;
    background: transparent;
    font-family: 'Caveat', cursive;
    font-size: 20px;
    color: var(--ink);
    outline: none;
    line-height: 40px;
    height: 40px;
    padding: 0;
    min-width: 0;
  }

  .line-text::placeholder {
    color: #ccc;
  }

  .line-tag-btn {
    padding: 2px 8px;
    font-size: 11px;
    border-radius: 8px;
    border: 1px dashed var(--line);
    background: transparent;
    color: var(--ink-light);
    cursor: pointer;
    white-space: nowrap;
    min-width: 24px;
    text-align: center;
    transition: all 0.15s;
    flex-shrink: 0;
    font-family: 'Inter', sans-serif;
    line-height: 1.4;
  }

  .line-tag-btn:hover {
    border-color: var(--tag-active);
    color: var(--tag-active);
    background: var(--tag-bg);
  }

  .line-tag-btn.has-tag {
    background: var(--tag-active);
    border: 1px solid var(--tag-active);
    color: white;
    font-weight: 500;
  }

  .line-tag-btn.has-tag:hover {
    background: #2980b9;
    color: white;
  }

  /* Tag dropdown */
  .tag-dropdown {
    position: fixed;
    z-index: 200;
    background: white;
    border: 1px solid var(--line);
    border-radius: 10px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    min-width: 200px;
    max-width: 260px;
    display: none;
    overflow: hidden;
  }

  .tag-dropdown.open {
    display: block;
  }

  .tag-dropdown-search {
    width: 100%;
    padding: 10px 12px;
    border: none;
    border-bottom: 1px solid var(--paper-dark);
    font-size: 13px;
    outline: none;
    color: var(--ink);
    background: var(--paper);
  }

  .tag-dropdown-search::placeholder {
    color: #bbb;
  }

  .tag-dropdown-list {
    max-height: 200px;
    overflow-y: auto;
    padding: 4px 0;
  }

  .tag-suggestion {
    padding: 8px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.1s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .tag-suggestion:hover {
    background: var(--tag-bg);
  }

  .tag-suggestion.active {
    background: var(--tag-bg);
  }

  .tag-suggestion.create {
    color: var(--tag-active);
    font-weight: 500;
    border-bottom: 1px solid var(--paper-dark);
  }

  .tag-suggestion.remove {
    color: var(--accent);
    border-top: 1px solid var(--paper-dark);
  }

  .tag-suggestion-empty {
    padding: 12px;
    font-size: 12px;
    color: var(--ink-light);
    text-align: center;
  }

  .tag-suggestion-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--tag-active);
    flex-shrink: 0;
  }

  /* Note count */
  .note-count {
    padding: 8px 20px;
    font-size: 11px;
    color: var(--ink-light);
    border-top: 1px solid var(--paper-dark);
    text-align: center;
  }

  /* Mobile */
  .mobile-toggle {
    display: none;
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 100;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 2px 8px var(--shadow);
  }

  @media (max-width: 768px) {
    .sidebar {
      position: fixed;
      left: -100%;
      top: 0;
      z-index: 99;
      width: 85%;
      transition: left 0.3s;
      box-shadow: 4px 0 12px var(--shadow);
    }

    .sidebar.open {
      left: 0;
    }

    .mobile-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .editor-toolbar {
      padding: 12px 16px;
    }

    .title-input {
      padding-left: 40px;
    }

    .lines-editor {
      padding-left: 40px;
    }

    .notebook-page::before {
      left: 28px;
    }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--line); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--ink-light); }

  /* File actions */
  .file-actions {
    display: flex;
    gap: 8px;
    padding: 0 20px 12px;
  }

  .file-btn {
    flex: 1;
    padding: 7px 0;
    border: 1px solid var(--line);
    border-radius: 6px;
    background: var(--paper);
    color: var(--ink-light);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .file-btn:hover {
    background: var(--tag-bg);
    color: var(--ink);
    border-color: var(--tag-active);
  }

  /* Overlay for mobile */
  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 98;
  }

  .overlay.visible {
    display: block;
  }
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h1>Mein Notizbuch</h1>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Notizen durchsuchen..." autocomplete="off">
    </div>
  </div>

  <div class="tags-section">
    <h3>Tags</h3>
    <div class="tag-filters" id="tagFilters"></div>
  </div>

  <button class="new-note-btn" id="newNoteBtn">+ Neue Notiz</button>

  <div class="file-actions">
    <button class="file-btn" id="exportBtn">Exportieren</button>
    <button class="file-btn" id="importBtn">Importieren</button>
  </div>
  <input type="file" id="importFile" accept=".json" style="display:none">

  <div class="notes-list-section" id="notesList"></div>

  <div class="note-count" id="noteCount"></div>
</aside>

<div class="overlay" id="overlay"></div>

<main class="main" id="mainArea">
  <div class="editor-empty" id="editorEmpty">
    Wahle eine Notiz oder erstelle eine neue...
  </div>

  <div class="editor-container" id="editorContainer" style="display:none">
    <div class="editor-toolbar">
      <div class="tag-input-wrapper">
        <label>Tipp: Klicke rechts neben einer Zeile auf den Tag-Button</label>
      </div>
      <button class="delete-note-btn" id="deleteNoteBtn">Loschen</button>
    </div>

    <div class="notebook-page">
      <input type="text" class="title-input" id="titleInput" placeholder="Titel...">
      <div class="lines-editor" id="linesEditor"></div>
    </div>

    <div class="tag-dropdown" id="tagDropdown">
      <input type="text" class="tag-dropdown-search" id="tagDropdownSearch" placeholder="Tag eingeben..." autocomplete="off">
      <div class="tag-dropdown-list" id="tagDropdownList"></div>
    </div>
  </div>
</main>

<button class="mobile-toggle" id="mobileToggle">&#9776;</button>

<script>
(function() {
  // --- State ---
  let notes = JSON.parse(localStorage.getItem('notizbuch_notes') || '[]');
  let activeNoteId = null;
  let activeTagFilter = null;
  let searchQuery = '';
  let saveTimeout = null;
  let activeDropdownLineIndex = null;
  let dropdownHighlightIndex = -1;

  // --- Migrate old notes (content string â†’ lines array) ---
  notes.forEach(n => {
    if (!n.lines) {
      const text = n.content || '';
      n.lines = text ? text.split('\n').map(t => ({ text: t, tag: '' })) : [{ text: '', tag: '' }];
    }
  });
  localStorage.setItem('notizbuch_notes', JSON.stringify(notes));

  // --- Elements ---
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  const mobileToggle = document.getElementById('mobileToggle');
  const searchInput = document.getElementById('searchInput');
  const tagFilters = document.getElementById('tagFilters');
  const notesList = document.getElementById('notesList');
  const noteCount = document.getElementById('noteCount');
  const newNoteBtn = document.getElementById('newNoteBtn');
  const editorEmpty = document.getElementById('editorEmpty');
  const editorContainer = document.getElementById('editorContainer');
  const titleInput = document.getElementById('titleInput');
  const linesEditor = document.getElementById('linesEditor');
  const deleteNoteBtn = document.getElementById('deleteNoteBtn');
  const tagDropdown = document.getElementById('tagDropdown');
  const tagDropdownSearch = document.getElementById('tagDropdownSearch');
  const tagDropdownList = document.getElementById('tagDropdownList');

  // --- Helpers ---
  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
  }

  function save() {
    localStorage.setItem('notizbuch_notes', JSON.stringify(notes));
  }

  function scheduleSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(save, 300);
  }

  function formatDate(ts) {
    const d = new Date(ts);
    return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })
      + ' ' + d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  function syncNoteFromLines(note) {
    note.content = note.lines.map(l => l.text).join('\n');
    note.tags = [...new Set(note.lines.map(l => l.tag).filter(Boolean))];
  }

  function getAllTags() {
    const tagMap = {};
    notes.forEach(n => {
      (n.tags || []).forEach(t => {
        tagMap[t] = (tagMap[t] || 0) + 1;
      });
    });
    return Object.entries(tagMap).sort((a, b) => b[1] - a[1]);
  }

  function getAllLineTags() {
    const tags = new Set();
    notes.forEach(n => {
      (n.lines || []).forEach(l => {
        if (l.tag) tags.add(l.tag);
      });
    });
    return [...tags].sort();
  }

  function getFilteredNotes() {
    let filtered = notes;

    if (activeTagFilter) {
      filtered = filtered.filter(n => (n.tags || []).includes(activeTagFilter));
    }

    if (searchQuery.trim()) {
      const q = searchQuery.toLowerCase().trim();
      filtered = filtered.filter(n =>
        (n.title || '').toLowerCase().includes(q) ||
        (n.content || '').toLowerCase().includes(q) ||
        (n.tags || []).some(t => t.toLowerCase().includes(q))
      );
    }

    return filtered.sort((a, b) => b.updatedAt - a.updatedAt);
  }

  function esc(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // --- Render ---
  function renderTagFilters() {
    const tags = getAllTags();
    let html = `<span class="tag-chip tag-chip-all ${!activeTagFilter ? 'active' : ''}" data-tag="">Alle <span class="tag-count">${notes.length}</span></span>`;
    tags.forEach(([tag, count]) => {
      html += `<span class="tag-chip ${activeTagFilter === tag ? 'active' : ''}" data-tag="${esc(tag)}">${esc(tag)} <span class="tag-count">${count}</span></span>`;
    });
    tagFilters.innerHTML = html;

    tagFilters.querySelectorAll('.tag-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const tag = chip.dataset.tag;
        activeTagFilter = tag || null;
        renderTagFilters();
        renderNotesList();
      });
    });
  }

  function renderNotesList() {
    const filtered = getFilteredNotes();
    if (filtered.length === 0) {
      notesList.innerHTML = '<div style="padding:20px;text-align:center;color:#aaa;font-size:13px;">Keine Notizen gefunden</div>';
    } else {
      notesList.innerHTML = filtered.map(n => {
        const preview = (n.content || '').replace(/\n/g, ' ').slice(0, 80);
        const tagsHtml = (n.tags || []).map(t => `<span class="note-item-tag">${esc(t)}</span>`).join('');
        return `
          <div class="note-item ${n.id === activeNoteId ? 'active' : ''}" data-id="${n.id}">
            <div class="note-item-title">${esc(n.title || 'Ohne Titel')}</div>
            <div class="note-item-preview">${esc(preview) || 'Leere Notiz'}</div>
            <div class="note-item-meta">
              <span class="note-item-date">${formatDate(n.updatedAt)}</span>
              ${tagsHtml}
            </div>
          </div>`;
      }).join('');
    }

    noteCount.textContent = `${filtered.length} von ${notes.length} Notizen`;

    notesList.querySelectorAll('.note-item').forEach(item => {
      item.addEventListener('click', () => {
        openNote(item.dataset.id);
        closeSidebarMobile();
      });
    });
  }

  // --- Lines Editor ---
  function renderLines() {
    const note = notes.find(n => n.id === activeNoteId);
    if (!note) return;
    if (!note.lines || note.lines.length === 0) {
      note.lines = [{ text: '', tag: '' }];
    }

    linesEditor.innerHTML = '';
    note.lines.forEach((line, i) => {
      const row = document.createElement('div');
      row.className = 'line-row';
      row.dataset.index = i;

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'line-text';
      input.value = line.text;
      if (i === 0 && note.lines.length === 1 && !line.text) {
        input.placeholder = 'Schreibe hier...';
      }

      const tagBtn = document.createElement('button');
      tagBtn.type = 'button';
      tagBtn.className = 'line-tag-btn' + (line.tag ? ' has-tag' : '');
      tagBtn.textContent = line.tag || '#';
      tagBtn.title = line.tag ? 'Tag: ' + line.tag : 'Tag hinzufuegen';

      // --- Line text events ---
      input.addEventListener('input', () => {
        note.lines[i].text = input.value;
        syncNoteFromLines(note);
        note.updatedAt = Date.now();
        scheduleSave();
        renderNotesList();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const pos = input.selectionStart;
          const before = input.value.slice(0, pos);
          const after = input.value.slice(pos);
          note.lines[i].text = before;
          note.lines.splice(i + 1, 0, { text: after, tag: '' });
          syncNoteFromLines(note);
          note.updatedAt = Date.now();
          save();
          renderLines();
          focusLine(i + 1, 0);
          renderNotesList();
        } else if (e.key === 'Backspace' && input.selectionStart === 0 && input.selectionEnd === 0 && i > 0) {
          e.preventDefault();
          const prevLen = note.lines[i - 1].text.length;
          note.lines[i - 1].text += note.lines[i].text;
          note.lines.splice(i, 1);
          syncNoteFromLines(note);
          note.updatedAt = Date.now();
          save();
          renderLines();
          focusLine(i - 1, prevLen);
          renderTagFilters();
          renderNotesList();
        } else if (e.key === 'ArrowUp' && i > 0) {
          e.preventDefault();
          focusLine(i - 1, Math.min(input.selectionStart, note.lines[i - 1].text.length));
        } else if (e.key === 'ArrowDown' && i < note.lines.length - 1) {
          e.preventDefault();
          focusLine(i + 1, Math.min(input.selectionStart, note.lines[i + 1].text.length));
        }
      });

      // --- Tag button event ---
      tagBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openTagDropdown(i, tagBtn);
      });

      row.appendChild(input);
      row.appendChild(tagBtn);
      linesEditor.appendChild(row);
    });
  }

  function focusLine(index, cursorPos) {
    requestAnimationFrame(() => {
      const rows = linesEditor.querySelectorAll('.line-row');
      if (rows[index]) {
        const input = rows[index].querySelector('.line-text');
        input.focus();
        if (typeof cursorPos === 'number') {
          input.setSelectionRange(cursorPos, cursorPos);
        }
      }
    });
  }

  // --- Tag Dropdown ---
  function openTagDropdown(lineIndex, btnElement) {
    activeDropdownLineIndex = lineIndex;
    dropdownHighlightIndex = -1;

    const rect = btnElement.getBoundingClientRect();
    tagDropdown.style.top = rect.bottom + 4 + 'px';
    tagDropdown.style.left = '';
    tagDropdown.style.right = '';

    // Position: try to align right edge with button right edge
    const dropdownWidth = 220;
    const rightEdge = rect.right;
    if (rightEdge - dropdownWidth < 0) {
      tagDropdown.style.left = Math.max(4, rect.left) + 'px';
    } else {
      tagDropdown.style.left = (rightEdge - dropdownWidth) + 'px';
    }

    tagDropdown.classList.add('open');
    tagDropdownSearch.value = '';
    tagDropdownSearch.focus();
    renderTagSuggestions('');
  }

  function closeTagDropdown() {
    tagDropdown.classList.remove('open');
    activeDropdownLineIndex = null;
    dropdownHighlightIndex = -1;
  }

  function renderTagSuggestions(query) {
    const allTags = getAllLineTags();
    const q = query.trim().toLowerCase();
    const filtered = q ? allTags.filter(t => t.includes(q)) : allTags;

    let html = '';

    // "Create new" option if query doesn't match existing
    if (q && !allTags.includes(q)) {
      html += `<div class="tag-suggestion create" data-tag="${esc(q)}" data-idx="0"><span class="tag-suggestion-dot"></span> "${esc(query.trim())}" erstellen</div>`;
    }

    filtered.forEach((tag, i) => {
      const idx = (q && !allTags.includes(q)) ? i + 1 : i;
      html += `<div class="tag-suggestion" data-tag="${esc(tag)}" data-idx="${idx}"><span class="tag-suggestion-dot"></span> ${esc(tag)}</div>`;
    });

    // "Remove tag" option if line has a tag
    const note = notes.find(n => n.id === activeNoteId);
    if (note && note.lines[activeDropdownLineIndex] && note.lines[activeDropdownLineIndex].tag) {
      html += `<div class="tag-suggestion remove" data-tag="" data-idx="${filtered.length + ((q && !allTags.includes(q)) ? 1 : 0)}">Tag entfernen</div>`;
    }

    if (!html) {
      html = '<div class="tag-suggestion-empty">Tippe einen Tag-Namen...</div>';
    }

    tagDropdownList.innerHTML = html;

    tagDropdownList.querySelectorAll('.tag-suggestion[data-tag]').forEach(item => {
      item.addEventListener('click', () => {
        selectTagForLine(item.dataset.tag);
      });
    });
  }

  function selectTagForLine(tag) {
    const note = notes.find(n => n.id === activeNoteId);
    if (!note || activeDropdownLineIndex === null) return;
    note.lines[activeDropdownLineIndex].tag = tag ? tag.trim().toLowerCase() : '';
    syncNoteFromLines(note);
    note.updatedAt = Date.now();
    save();
    renderLines();
    renderTagFilters();
    renderNotesList();
    closeTagDropdown();
  }

  // Dropdown search input events
  tagDropdownSearch.addEventListener('input', () => {
    dropdownHighlightIndex = -1;
    renderTagSuggestions(tagDropdownSearch.value);
  });

  tagDropdownSearch.addEventListener('keydown', (e) => {
    const items = tagDropdownList.querySelectorAll('.tag-suggestion[data-tag]');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      dropdownHighlightIndex = Math.min(dropdownHighlightIndex + 1, items.length - 1);
      updateDropdownHighlight(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      dropdownHighlightIndex = Math.max(dropdownHighlightIndex - 1, 0);
      updateDropdownHighlight(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (dropdownHighlightIndex >= 0 && items[dropdownHighlightIndex]) {
        selectTagForLine(items[dropdownHighlightIndex].dataset.tag);
      } else {
        // Create/assign the typed tag
        const val = tagDropdownSearch.value.trim().toLowerCase();
        if (val) selectTagForLine(val);
      }
    } else if (e.key === 'Escape') {
      closeTagDropdown();
    }
  });

  function updateDropdownHighlight(items) {
    items.forEach((item, i) => {
      item.classList.toggle('active', i === dropdownHighlightIndex);
    });
    if (items[dropdownHighlightIndex]) {
      items[dropdownHighlightIndex].scrollIntoView({ block: 'nearest' });
    }
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!tagDropdown.contains(e.target) && !e.target.classList.contains('line-tag-btn')) {
      closeTagDropdown();
    }
  });

  // --- Actions ---
  function createNote() {
    const note = {
      id: generateId(),
      title: '',
      content: '',
      tags: [],
      lines: [{ text: '', tag: '' }],
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
    notes.unshift(note);
    save();
    openNote(note.id);
    renderTagFilters();
    renderNotesList();
    titleInput.focus();
    closeSidebarMobile();
  }

  function openNote(id) {
    activeNoteId = id;
    const note = notes.find(n => n.id === id);
    if (!note) return;

    // Ensure lines exist
    if (!note.lines || note.lines.length === 0) {
      const text = note.content || '';
      note.lines = text ? text.split('\n').map(t => ({ text: t, tag: '' })) : [{ text: '', tag: '' }];
    }

    editorEmpty.style.display = 'none';
    editorContainer.style.display = 'flex';

    titleInput.value = note.title || '';
    closeTagDropdown();
    renderLines();
    renderNotesList();
  }

  function closeEditor() {
    activeNoteId = null;
    editorEmpty.style.display = 'flex';
    editorContainer.style.display = 'none';
    closeTagDropdown();
    renderNotesList();
  }

  function deleteNote() {
    if (!activeNoteId) return;
    const note = notes.find(n => n.id === activeNoteId);
    if (!note) return;
    if (!confirm(`Notiz "${note.title || 'Ohne Titel'}" wirklich loschen?`)) return;
    notes = notes.filter(n => n.id !== activeNoteId);
    save();
    closeEditor();
    renderTagFilters();
    renderNotesList();
  }

  function closeSidebarMobile() {
    sidebar.classList.remove('open');
    overlay.classList.remove('visible');
  }

  // --- Events ---
  newNoteBtn.addEventListener('click', createNote);
  deleteNoteBtn.addEventListener('click', deleteNote);

  titleInput.addEventListener('input', () => {
    const note = notes.find(n => n.id === activeNoteId);
    if (!note) return;
    note.title = titleInput.value;
    note.updatedAt = Date.now();
    scheduleSave();
    renderNotesList();
  });

  titleInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      focusLine(0, 0);
    }
  });

  searchInput.addEventListener('input', () => {
    searchQuery = searchInput.value;
    renderNotesList();
  });

  mobileToggle.addEventListener('click', () => {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('visible');
  });

  overlay.addEventListener('click', closeSidebarMobile);

  // --- Export / Import ---
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');

  exportBtn.addEventListener('click', () => {
    const data = JSON.stringify(notes, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'notizbuch_' + new Date().toISOString().slice(0, 10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  importBtn.addEventListener('click', () => importFile.click());

  importFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const imported = JSON.parse(evt.target.result);
        if (!Array.isArray(imported)) {
          alert('Ungueltige Datei: Erwartet ein Array von Notizen.');
          return;
        }
        const existingIds = new Set(notes.map(n => n.id));
        let added = 0;
        imported.forEach(n => {
          if (n.id && !existingIds.has(n.id)) {
            // Migrate imported notes too
            if (!n.lines) {
              const text = n.content || '';
              n.lines = text ? text.split('\n').map(t => ({ text: t, tag: '' })) : [{ text: '', tag: '' }];
            }
            notes.push(n);
            existingIds.add(n.id);
            added++;
          }
        });
        save();
        renderTagFilters();
        renderNotesList();
        alert(`${added} neue Notiz(en) importiert. ${imported.length - added} bereits vorhanden.`);
      } catch (err) {
        alert('Fehler beim Lesen der Datei: ' + err.message);
      }
    };
    reader.readAsText(file);
    importFile.value = '';
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      createNote();
    }
  });

  // --- Init ---
  renderTagFilters();
  renderNotesList();
})();
</script>
</body>
</html>
